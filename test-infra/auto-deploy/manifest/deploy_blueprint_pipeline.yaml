# A Tekton PipelineRune to deploy Kubeflow using a blueprint.
apiVersion: tekton.dev/v1alpha1
kind: PipelineRun
metadata:
  generateName: deploy-gcp-
  namespace: auto-deploy
spec:
  # tODO(jlewi): Override any parameters?
  #params: {}
  resources:  
  - name: blueprint-repo
    resourceSpec:
      type: git
      params:
        # TODO(jlewi): Switch to master on kubeflow/gcp-blueprints
        - name: revision
          value: auto_deploy
        - name: url
          value: https://github.com/jlewi/gcp-blueprints.git
  - name: testing-repo
    resourceSpec:
      type: git
      params:
        # TODO(jlewi): Switch to master on kubeflow/gcp-blueprints
        - name: revision
          value: gcp_blueprint
        - name: url
          value: https://github.com/jlewi/testing.git
  # Need to use a KSA with appropriate GSA
  serviceAccountName: default-editor
  pipelineSpec:
    params:
    - name: management-cluster-name
      type: string
      description: The name of the management cluster. 
      default: "kf-ci-management"
    resources:
    - name: testing-repo
      type: git
    - name: blueprint-repo
      type: git
    tasks:
    - name: deploy-gcp
      # TODO(jlewi): expose other parameters? Right now
      # we are just relying on the defaults defined in the task
      params:
      - name: management-cluster-name
        value: "$(params.management-cluster-name)"
      resources:
        inputs:
        - name: blueprint-repo
          resource: blueprint-repo
        - name: testing-repo
          resource: testing-repo
      taskRef:
        name: deploy-gcp-blueprint
        kind: namespaced  