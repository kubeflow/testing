apiVersion: batch/v1
kind: Job
metadata:
  generateName: deploy-master-
  namespace: kubeflow-test-infra
spec:
  template:
    spec:
      containers:
      - name: deploy-worker
        image: gcr.io/kubeflow-ci/deploy-worker:v20190228-e625074-dirty-decd62
        env:
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /secret/gcp-credentials/key.json
        command:
        - /usr/local/bin/init.sh
        - --src_dir=/src
        - --repo_owner=kubeflow
        - --repo_branches=kubeflow/master,testing/master
        - --project=kubeflow-ci
        - --worker_cluster=kubeflow-testing
        - --job_labels=/etc/pod-info/labels
        - --nfs_mnt=/mnt/test-data-volume
        - --base_name=kf-vmaster
        - --max_num_cluster=5
        - --zone=us-east1-b
        volumeMounts:
        - name: gcp-credentials
          mountPath: "/secret/gcp-credentials"
          readOnly: true
        - name: pod-info
          mountPath: "/etc/pod-info"
          readOnly: true
        - name: github-token
          mountPath: "/secret/github-token"
          readOnly: true
        - name: test-data-volume
          mountPath: "/mnt/test-data-volume"
          readOnly: false
      restartPolicy: Never
      volumes:
      - name: gcp-credentials
        secret:
          secretName: gcp-credentials
      - name: github-token
        secret:
          secretName: github-token
      - name: test-data-volume
        persistentVolumeClaim:
          claimName: nfs-external
      - name: pod-info
        downwardAPI:
          items:
            - path: "labels"
              fieldRef:
                fieldPath: metadata.labels
