# A Tekton task to deploy Kubeflow using the GCP blueprint.
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: deploy-gcp-blueprint
  # TODO(jlewi): Should we use a ClusterTask
  namespace: tektoncd
  annotations:
    sidecar.istio.io/inject: "false"
spec:
  inputs:
    params:
    - name: name
      type: string
      description: The name for the Kubeflow deployment
      default: "kf-vbp-{uid}"
    - name: project
      type: string
      description: The project to deploy into.
      default: "kubeflow-ci-deployment"
    - name: management-cluster-name
      type: string
      description: The name of the management cluster.
      default: "kf-ci-management"
    - name: management-project
      type: string
      description: The project containing the management cluster
      default: kubeflow-ci
    - name: management-location
      type: string
      description: The location of the management cluster
      default: us-central1
    resources:
    - name: testing-repo
      type: git
      description: The GitHub repo containing kubeflow testing scripts
    - name: blueprint-repo
      type: git
      description: The GitHub repo containing the blueprint
  stepTemplate:
    env:
    - name: KUBECONFIG
      value: /workspace/kubeconfig
<<<<<<< HEAD
    image: gcr.io/kubeflow-ci/test-worker-py3:59b3b5d-dirty@sha256:58701d52b9fba37e7082c8e530b05fd533fb9a5ada5055c5f1443c0c4b9c8c43 # {"type":"string","x-kustomize":{"setBy":"kpt","partialSetters":[{"name":"test-image","value":"gcr.io/kubeflow-ci/test-worker-py3:59b3b5d-dirty@sha256:58701d52b9fba37e7082c8e530b05fd533fb9a5ada5055c5f1443c0c4b9c8c43"}]}}
=======
    image: gcr.io/kubeflow-ci/test-worker-py3:4a56d44-dirty@sha256:cf45693453e331e89d0540ed8c2436528eec4db63f9ce4967591bb023b166417 # {"type":"string","x-kustomize":{"setBy":"kpt","partialSetters":[{"name":"test-image","value":"gcr.io/kubeflow-ci/test-worker-py3:4a56d44-dirty@sha256:cf45693453e331e89d0540ed8c2436528eec4db63f9ce4967591bb023b166417"}]}}
>>>>>>> 11a620e... Setup a kf-ci-dev namespace for manual sync'ing of Tekton pipelines.
  steps:
  - name: get-credential
    command:
    - /workspace/$(inputs.resources.blueprint-repo.name)/kubeflow/hack/create_context.sh
    env:
    - name: PROJECT
      value: $(inputs.params.management-project)
    - name: REGION
      value: $(inputs.params.management-location)
    - name: NAME
      value: $(inputs.params.management-cluster-name)
    - name: NAMESPACE
      value: $(inputs.params.project)
  - name: deploy-gcp
    command:
    - python
    - -m
    - kubeflow.testing.create_kf_from_gcp_blueprint
    - deploy
    - --name=$(inputs.params.name)
    - --blueprint-dir=/workspace/$(inputs.resources.blueprint-repo.name)/kubeflow
    # The previous step should give the context for the management cluster the same name as the 
    # management cluster.
    - --management-context=$(inputs.params.management-cluster-name)
    - --labels-file=/etc/podinfo/labels
    workingDir: /workspace/$(inputs.resources.blueprint-repo.name)/kubeflow
    env:
    - name: PYTHONPATH
      value: /workspace/$(inputs.resources.testing-repo.name)/py
    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo
  volumes:
  - name: podinfo
    downwardAPI:
      items:
      - path: "labels"
        fieldRef:
          fieldPath: metadata.labels
