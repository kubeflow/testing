apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: test-teardown
  namespace: tektoncd
  annotations:
    sidecar.istio.io/inject: "false"
spec:
  workspaces:
  - name: junit-artifacts
  inputs:
    params:
    - name: workflow-name
      type: string
      description:
        Path to the directory with artifacts to upload to GCS.
    # params below are from prow jobs.
    - name: test-target-name
      type: string
      description:
        Test target name from Prow ENV. Should be provided at runtime.
    - name: repo-owner
      type: string
      description:
        Testing repo owner from Prow ENV.
    - name: prow-job-id
      type: string
      description:
        Prow job ID from Prow ENV.
    - name: job-type
      type: string
      description:
        Job type from Prow ENV.
    - name: job-name
      type: string
      description:
        Job name from Prow ENV.
    - name: repo-name
      type: string
      description:
        Testing repo name from Prow ENV.
    - name: pull-number
      type: string
      description:
        Pull number from Prow ENV.
    - name: build-id
      type: string
      description:
        BUILD_ID from Prow ENV.
  steps:
  - name: copy-artifacts
    image: gcr.io/kubeflow-ci/test-worker:latest
    command:
    - python
    args:
    - -m
    - kubeflow.testing.prow_artifacts
    - --artifacts_dir=$(workspaces.junit-artifacts.path)/$(inputs.params.workflow-name)
    - copy_artifacts
    env:
    - name: PYTHONPATH
      value: /workspace/src/kubeflow/testing/py
    - name: TEST_TARGET_NAME
      value: $(inputs.params.test-target-name)
    - name: REPO_OWNER
      value: $(inputs.params.repo-owner)
    - name: PROW_JOB_ID
      value: $(inputs.params.prow-job-id)
    - name: JOB_TYPE
      value: $(inputs.params.job-type)
    - name: JOB_NAME
      value: $(inputs.params.job-name)
    - name: REPO_NAME
      value: $(inputs.params.repo-name)
    - name: PULL_NUMBER
      value: $(inputs.params.pull-number)
    - name: BUILD_ID
      value: $(inputs.params.build-id)
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/gcp-credentials/key.json
    volumeMounts:
    - name: gcp-credentials
      readOnly: true
      mountPath: /secret/gcp-credentials
  volumes:
  - name: gcp-credentials
    secret:
      secretName: gcp-credentials
